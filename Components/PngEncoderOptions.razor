@using SixLabors.ImageSharp.Formats
@using SixLabors.ImageSharp.Formats.Png
@attribute [FormatEncoder(typeof(PngFormat))]
@inherits EncoderOptionsBase

<MudText Typo="Typo.body2" Class="mb-2">压缩级别：@_compressionLevel</MudText>
<MudSlider T="int" @bind-Value="_compressionLevel" @bind-Value:after="NotifyEncoderChanged"
           Min="0" Max="9" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />

<MudSelect T="PngColorType?" @bind-Value="_colorType" @bind-Value:after="NotifyEncoderChanged"
           Label="颜色类型" Variant="Variant.Outlined" Class="mb-4">
    <MudSelectItem T="PngColorType?" Value="@((PngColorType?)null)">自动</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Rgb">RGB</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.RgbWithAlpha">RGBA</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Grayscale">灰度</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.GrayscaleWithAlpha">灰度 + 透明</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Palette">调色板</MudSelectItem>
</MudSelect>

<MudSwitch T="bool" @bind-Value="_interlace" @bind-Value:after="NotifyEncoderChanged"
           Color="MudBlazor.Color.Primary" Class="mb-4"
           Label="Adam7 交错（渐进式加载）" />

<MudExpansionPanels Elevation="0" Dense="true" Class="mb-2 border-solid border rounded mud-border-primary">
    <MudExpansionPanel>
        <TitleContent>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Tune" Size="MudBlazor.Size.Small" Class="mr-2" />
                <MudText Typo="Typo.body2">高级选项</MudText>
            </div>
        </TitleContent>
        <ChildContent>
        <MudSelect T="PngBitDepth?" @bind-Value="_bitDepth" @bind-Value:after="NotifyEncoderChanged"
                   Label="位深度" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngBitDepth?" Value="@((PngBitDepth?)null)">自动</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit1">1 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit2">2 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit4">4 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit8">8 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit16">16 位</MudSelectItem>
        </MudSelect>

        <MudSelect T="PngFilterMethod?" @bind-Value="_filterMethod" @bind-Value:after="NotifyEncoderChanged"
                   Label="滤波方法" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngFilterMethod?" Value="@((PngFilterMethod?)null)">自动</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.None">None</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Sub">Sub</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Up">Up</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Average">Average</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Paeth">Paeth</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Adaptive">Adaptive</MudSelectItem>
        </MudSelect>

        <MudSelect T="PngTransparentColorMode" @bind-Value="_transparentColorMode" @bind-Value:after="NotifyEncoderChanged"
                   Label="透明色处理" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngTransparentColorMode" Value="PngTransparentColorMode.Preserve">保留</MudSelectItem>
            <MudSelectItem T="PngTransparentColorMode" Value="PngTransparentColorMode.Clear">清除为透明黑</MudSelectItem>
        </MudSelect>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    private int _compressionLevel = 6;
    private PngColorType? _colorType;
    private bool _interlace;
    private PngBitDepth? _bitDepth;
    private PngFilterMethod? _filterMethod;
    private PngTransparentColorMode _transparentColorMode = PngTransparentColorMode.Preserve;

    protected override IImageEncoder BuildEncoder() =>
        new PngEncoder
        {
            CompressionLevel = (PngCompressionLevel)_compressionLevel,
            ColorType = _colorType,
            InterlaceMethod = _interlace ? PngInterlaceMode.Adam7 : PngInterlaceMode.None,
            BitDepth = _bitDepth,
            FilterMethod = _filterMethod,
            TransparentColorMode = _transparentColorMode,
            SkipMetadata = SkipMetadata
        };
}
