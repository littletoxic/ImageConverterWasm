@using SixLabors.ImageSharp.Formats
@using SixLabors.ImageSharp.Formats.Png
@attribute [FormatEncoder(typeof(PngFormat))]
@inherits EncoderOptionsBase

<MudText Typo="Typo.body2" Class="mb-2">压缩级别：@_compressionLevel</MudText>
<MudSlider T="int" Value="_compressionLevel" ValueChanged="OnCompressionLevelChanged"
           Min="0" Max="9" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />

<MudSelect T="PngColorType?" Value="_colorType" ValueChanged="OnColorTypeChanged"
           Label="颜色类型" Variant="Variant.Outlined" Class="mb-4">
    <MudSelectItem T="PngColorType?" Value="@((PngColorType?)null)">自动</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Rgb">RGB</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.RgbWithAlpha">RGBA</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Grayscale">灰度</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.GrayscaleWithAlpha">灰度 + 透明</MudSelectItem>
    <MudSelectItem T="PngColorType?" Value="PngColorType.Palette">调色板</MudSelectItem>
</MudSelect>

<MudSwitch T="bool" Value="_interlace" ValueChanged="OnInterlaceChanged"
           Color="MudBlazor.Color.Primary" Class="mb-4"
           Label="Adam7 交错（渐进式加载）" />

<MudExpansionPanels Elevation="0" Dense="true" Class="mb-2 border-solid border rounded mud-border-primary">
    <MudExpansionPanel>
        <TitleContent>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Tune" Size="MudBlazor.Size.Small" Class="mr-2" Color="MudBlazor.Color.Primary" />
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Primary">高级选项</MudText>
            </div>
        </TitleContent>
        <ChildContent>
        <MudSelect T="PngBitDepth?" Value="_bitDepth" ValueChanged="OnBitDepthChanged"
                   Label="位深度" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngBitDepth?" Value="@((PngBitDepth?)null)">自动</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit1">1 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit2">2 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit4">4 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit8">8 位</MudSelectItem>
            <MudSelectItem T="PngBitDepth?" Value="PngBitDepth.Bit16">16 位</MudSelectItem>
        </MudSelect>

        <MudSelect T="PngFilterMethod?" Value="_filterMethod" ValueChanged="OnFilterMethodChanged"
                   Label="滤波方法" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngFilterMethod?" Value="@((PngFilterMethod?)null)">自动</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.None">None</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Sub">Sub</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Up">Up</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Average">Average</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Paeth">Paeth</MudSelectItem>
            <MudSelectItem T="PngFilterMethod?" Value="PngFilterMethod.Adaptive">Adaptive</MudSelectItem>
        </MudSelect>

        <MudSelect T="PngTransparentColorMode" Value="_transparentColorMode" ValueChanged="OnTransparentColorModeChanged"
                   Label="透明色处理" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="PngTransparentColorMode" Value="PngTransparentColorMode.Preserve">保留</MudSelectItem>
            <MudSelectItem T="PngTransparentColorMode" Value="PngTransparentColorMode.Clear">清除为透明黑</MudSelectItem>
        </MudSelect>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    private int _compressionLevel = 6;
    private PngColorType? _colorType;
    private bool _interlace;
    private PngBitDepth? _bitDepth;
    private PngFilterMethod? _filterMethod;
    private PngTransparentColorMode _transparentColorMode = PngTransparentColorMode.Preserve;

    private async Task OnCompressionLevelChanged(int value)
    {
        _compressionLevel = value;
        await NotifyEncoderChanged();
    }

    private async Task OnColorTypeChanged(PngColorType? value)
    {
        _colorType = value;
        await NotifyEncoderChanged();
    }

    private async Task OnInterlaceChanged(bool value)
    {
        _interlace = value;
        await NotifyEncoderChanged();
    }

    private async Task OnBitDepthChanged(PngBitDepth? value)
    {
        _bitDepth = value;
        await NotifyEncoderChanged();
    }

    private async Task OnFilterMethodChanged(PngFilterMethod? value)
    {
        _filterMethod = value;
        await NotifyEncoderChanged();
    }

    private async Task OnTransparentColorModeChanged(PngTransparentColorMode value)
    {
        _transparentColorMode = value;
        await NotifyEncoderChanged();
    }

    protected override IImageEncoder BuildEncoder() =>
        new PngEncoder
        {
            CompressionLevel = (PngCompressionLevel)_compressionLevel,
            ColorType = _colorType,
            InterlaceMethod = _interlace ? PngInterlaceMode.Adam7 : PngInterlaceMode.None,
            BitDepth = _bitDepth,
            FilterMethod = _filterMethod,
            TransparentColorMode = _transparentColorMode,
            SkipMetadata = SkipMetadata
        };
}
