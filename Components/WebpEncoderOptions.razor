@using SixLabors.ImageSharp.Formats
@using SixLabors.ImageSharp.Formats.Webp
@attribute [FormatEncoder(typeof(WebpFormat))]
@inherits EncoderOptionsBase

<MudSwitch T="bool" Value="_lossless" ValueChanged="OnLosslessChanged"
           Color="MudBlazor.Color.Primary" Class="mb-2"
           Label="@(_lossless ? "无损模式（内存占用更高）" : "有损模式")" />

<MudText Typo="Typo.body2" Class="mb-2">@(_lossless ? "压缩努力程度" : "WebP 质量")：@_quality</MudText>
<MudSlider T="int" Value="_quality" ValueChanged="OnQualityChanged"
           Min="0" Max="100" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />

<MudExpansionPanels Elevation="0" Dense="true" Class="mb-2 border-solid border rounded mud-border-primary">
    <MudExpansionPanel>
        <TitleContent>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Tune" Size="MudBlazor.Size.Small" Class="mr-2" Color="MudBlazor.Color.Primary" />
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Primary">高级选项</MudText>
            </div>
        </TitleContent>
        <ChildContent>
        <MudText Typo="Typo.body2" Class="mb-2">压缩方法（0=最快，6=最慢最小）：@_method</MudText>
        <MudSlider T="int" Value="_method" ValueChanged="OnMethodChanged"
                   Min="0" Max="6" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />

        <MudText Typo="Typo.body2" Class="mb-2">去块滤波强度：@_filterStrength</MudText>
        <MudSlider T="int" Value="_filterStrength" ValueChanged="OnFilterStrengthChanged"
                   Min="0" Max="100" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />

        @if (_lossless)
        {
            <MudSwitch T="bool" Value="_nearLossless" ValueChanged="OnNearLosslessChanged"
                       Color="MudBlazor.Color.Primary" Class="mb-2"
                       Label="近似无损" />

            @if (_nearLossless)
            {
                <MudText Typo="Typo.body2" Class="mb-2">近似无损质量：@_nearLosslessQuality</MudText>
                <MudSlider T="int" Value="_nearLosslessQuality" ValueChanged="OnNearLosslessQualityChanged"
                           Min="0" Max="100" Step="1" Color="MudBlazor.Color.Primary" Class="mb-4" />
            }
        }

        <MudSelect T="WebpTransparentColorMode" Value="_transparentColorMode" ValueChanged="OnTransparentColorModeChanged"
                   Label="透明色处理" Variant="Variant.Outlined" Class="mb-4">
            <MudSelectItem T="WebpTransparentColorMode" Value="WebpTransparentColorMode.Preserve">保留</MudSelectItem>
            <MudSelectItem T="WebpTransparentColorMode" Value="WebpTransparentColorMode.Clear">清除</MudSelectItem>
        </MudSelect>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    private int _quality = 75;
    private bool _lossless;
    private int _method = 4;
    private int _filterStrength = 60;
    private bool _nearLossless;
    private int _nearLosslessQuality = 60;
    private WebpTransparentColorMode _transparentColorMode = WebpTransparentColorMode.Preserve;

    private async Task OnLosslessChanged(bool value)
    {
        _lossless = value;
        await NotifyEncoderChanged();
    }

    private async Task OnQualityChanged(int value)
    {
        _quality = value;
        await NotifyEncoderChanged();
    }

    private async Task OnMethodChanged(int value)
    {
        _method = value;
        await NotifyEncoderChanged();
    }

    private async Task OnFilterStrengthChanged(int value)
    {
        _filterStrength = value;
        await NotifyEncoderChanged();
    }

    private async Task OnNearLosslessChanged(bool value)
    {
        _nearLossless = value;
        await NotifyEncoderChanged();
    }

    private async Task OnNearLosslessQualityChanged(int value)
    {
        _nearLosslessQuality = value;
        await NotifyEncoderChanged();
    }

    private async Task OnTransparentColorModeChanged(WebpTransparentColorMode value)
    {
        _transparentColorMode = value;
        await NotifyEncoderChanged();
    }

    protected override IImageEncoder BuildEncoder() =>
        new WebpEncoder
        {
            FileFormat = _lossless ? WebpFileFormatType.Lossless : WebpFileFormatType.Lossy,
            Quality = _quality,
            Method = (WebpEncodingMethod)_method,
            FilterStrength = _filterStrength,
            NearLossless = _nearLossless,
            NearLosslessQuality = _nearLosslessQuality,
            TransparentColorMode = _transparentColorMode,
            SkipMetadata = SkipMetadata
        };
}
