
<MudCard Elevation="2" Class="d-flex flex-column" Style="height: 100%">
    <div class="d-flex align-center justify-center overflow-hidden"
         style="height: 160px; background: #f5f5f5; cursor: pointer;"
         @onclick="OpenPreview">
        <MudImage Src="@(Item.ThumbnailUrl ?? "")" Alt="@Item.FileName"
                  ObjectFit="ObjectFit.Contain"
                  Style="max-width: 100%; max-height: 100%" />
    </div>
    <MudCardContent Class="pa-3 pb-1 flex-grow-1">
        <MudTooltip Text="@Item.FileName" Inline="false">
            <MudText Typo="Typo.body2"
                     Style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                @Item.FileName
            </MudText>
        </MudTooltip>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
            <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                @FormatInfo.FormatFileSize(Item.FileSize)
            </MudText>
            @if (Item.Job is { IsLoaded: true })
            {
                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Secondary">
                    @(Item.Job.Width)x@(Item.Job.Height)
                </MudText>
            }
        </MudStack>
        @switch (Item.Status)
        {
            case ImageItemStatus.Loading:
                <MudProgressLinear Indeterminate="true" Color="MudBlazor.Color.Primary" Class="mt-2" />
                break;
            case ImageItemStatus.Pending:
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Info"
                         Class="mt-2">待转换</MudChip>
                break;
            case ImageItemStatus.Converting:
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Warning"
                         Class="mt-2">
                    <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true"
                                         Class="mr-1" Style="width:14px;height:14px;" />
                    转换中
                </MudChip>
                break;
            case ImageItemStatus.Done:
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Success"
                         Class="mt-2">
                    已完成 (@FormatInfo.FormatFileSize(Item.Result?.Size ?? 0))
                </MudChip>
                break;
            case ImageItemStatus.Error:
                <MudTooltip Text="@Item.ErrorMessage">
                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Error"
                             Class="mt-2">
                        错误
                    </MudChip>
                </MudTooltip>
                break;
        }
    </MudCardContent>
    <MudCardActions Class="pa-2 pt-0">
        <MudTooltip Text="转换">
            <MudIconButton Icon="@Icons.Material.Filled.Transform"
                           Color="MudBlazor.Color.Primary"
                           Size="MudBlazor.Size.Small"
                           Disabled="@(Busy || Item.Status is not ImageItemStatus.Pending and not ImageItemStatus.Done and not ImageItemStatus.Error)"
                           OnClick="() => OnConvert.InvokeAsync(Item)" />
        </MudTooltip>
        <MudTooltip Text="下载">
            <MudIconButton Icon="@Icons.Material.Filled.Download"
                           Color="MudBlazor.Color.Primary"
                           Size="MudBlazor.Size.Small"
                           Disabled="@(Item.Status is not ImageItemStatus.Done)"
                           OnClick="() => OnDownload.InvokeAsync(Item)" />
        </MudTooltip>
        <MudSpacer />
        <MudTooltip Text="移除">
            <MudIconButton Icon="@Icons.Material.Filled.Close"
                           Color="MudBlazor.Color.Error"
                           Size="MudBlazor.Size.Small"
                           Disabled="Busy"
                           OnClick="() => OnRemove.InvokeAsync(Item)" />
        </MudTooltip>
    </MudCardActions>
</MudCard>

<MudOverlay Visible="_previewVisible" DarkBackground="true" AutoClose="true"
            OnClosed="() => _previewVisible = false"
            Class="d-flex align-center justify-center">
    @if (_previewUrl is null)
    {
        <MudProgressCircular Indeterminate="true" Color="MudBlazor.Color.Primary" />
    }
    else
    {
        <MudImage Src="@_previewUrl" Alt="@Item.FileName"
                  ObjectFit="ObjectFit.Contain"
                  Style="max-width: 90vw; max-height: 85vh; cursor: pointer;"
                  @onclick="() => _previewVisible = false" />
    }
</MudOverlay>

@code {
    [Parameter, EditorRequired] public required ImageItem Item { get; set; }
    [Parameter] public bool Busy { get; set; }
    [Parameter] public EventCallback<ImageItem> OnConvert { get; set; }
    [Parameter] public EventCallback<ImageItem> OnDownload { get; set; }
    [Parameter] public EventCallback<ImageItem> OnRemove { get; set; }

    private bool _previewVisible;
    private string? _previewUrl;

    private async Task OpenPreview()
    {
        if (Item.Job is not { IsLoaded: true }) return;

        _previewVisible = true;
        _previewUrl = null;
        StateHasChanged();

        await Task.Yield();
        _previewUrl = Item.Job.ToThumbnailDataUrl(1024);
        StateHasChanged();
    }
}
