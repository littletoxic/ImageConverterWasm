@using SixLabors.ImageSharp.Formats

<MudPaper Class="@($"pa-4 {Class}")" Elevation="2">
    <MudText Typo="Typo.h6" GutterBottom="true">转换设置</MudText>

    <MudSelect T="IImageFormat"
               Label="目标格式"
               @bind-Value="TargetFormat"
               @bind-Value:after="() => TargetFormatChanged.InvokeAsync(TargetFormat)"
               Variant="Variant.Outlined"
               Class="mb-4">
        @foreach (var format in FormatInfo.EncodableFormats)
        {
            <MudSelectItem Value="@format">@format.Name</MudSelectItem>
        }
    </MudSelect>

    <MudSwitch T="bool" @bind-Value="_stripMetadata" @bind-Value:after="SyncStripMetadata"
               Color="MudBlazor.Color.Primary" Class="mb-4"
               Label="剥离元数据（EXIF、XMP 等）" />

    @{
        var componentType = EncoderOptionsBase.GetComponentType(TargetFormat);
    }
    @if (componentType is not null)
    {
        <DynamicComponent Type="componentType" Parameters="_encoderParams" />
    }
</MudPaper>

@code {
    [Parameter] public IImageFormat TargetFormat { get; set; } = default!;
    [Parameter] public EventCallback<IImageFormat> TargetFormatChanged { get; set; }
    [Parameter] public EventCallback<IImageEncoder> EncoderChanged { get; set; }
    [Parameter] public string? Class { get; set; }

    private bool _stripMetadata;
    private Dictionary<string, object>? _encoderParams;

    protected override void OnInitialized()
    {
        _encoderParams = new Dictionary<string, object>
        {
            [nameof(EncoderOptionsBase.EncoderChanged)] =
                EventCallback.Factory.Create<IImageEncoder>(this,
                    encoder => EncoderChanged.InvokeAsync(encoder)),
            [nameof(EncoderOptionsBase.SkipMetadata)] = _stripMetadata,
        };
    }

    private void SyncStripMetadata() =>
        _encoderParams![nameof(EncoderOptionsBase.SkipMetadata)] = _stripMetadata;
}
